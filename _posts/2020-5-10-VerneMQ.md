---
layout: post
title: VerneMQ on Docker + Redis Auth 
---


1. Start services via `docker-compose.yml`:
{% highlight docker %}
version: '3.5'

volumes:
  redis-master:
    driver: local

services:

  vernemq:
    image: vernemq/vernemq
    container_name: vernemq
    environment:
      DOCKER_VERNEMQ_ACCEPT_EULA: 'yes'
      DOCKER_VERNEMQ_ALLOW_ANONYMOUS: 'off'
      DOCKER_VERNEMQ_PLUGINS.vmq_passwd: 'off'
      DOCKER_VERNEMQ_PLUGINS.vmq_acl: 'off'
      DOCKER_VERNEMQ_PLUGINS.vmq_diversity: 'on'
      DOCKER_VERNEMQ_VMQ_DIVERSITY.auth_redis.enabled: 'on'
      DOCKER_VERNEMQ_VMQ_DIVERSITY.redis.host: redis-master
      DOCKER_VERNEMQ_VMQ_DIVERSITY.redis.port: 6379
      DOCKER_VERNEMQ_VMQ_DIVERSITY.redis.password: redis
    ports:
      - 1883:1883
      - 8080:8080
      - 8888:8888
    depends_on:
      - redis-master

  redis-master:
    container_name: redis-master
    image: bitnami/redis:5.0.8
    ports:
      - 6379:6379
    environment:
      - REDIS_REPLICATION_MODE=master
      - REDIS_PASSWORD=redis
    volumes:
      - redis-master:/bitnami/redis/data
{% endhighlight %}


2. Configure auth data

- mountpoint=
- client_id=`test_client`
- username=`test_user`
- password=`123`
- ACL: `publish_acl={pattern:'a/+/c'}`, `subscribe_acl={pattern:'a/+/c'}`

Redis doesn't support [Bcrypt](https://en.wikipedia.org/wiki/Bcrypt) password hashing function thus it must be computed explicitly (e.g. using online tool: [Online Bcrypt hash generator](https://8gwifi.org/bccrypt.jsp))
~~~
Brypt(pass='123',round=12) = $2a$12$uiPXR.maWj5J7Uo9mhjuMe6r.c8b1/sZtEzWV7ptkMnIomFy3l.s2
~~~   

Commands to execute:
{% highlight shell linenos %}
    docker exec -it redis-master bash
    redis-cli -a redis
    SET "[\"\",\"test-client\",\"test-user\"]" "{\"passhash\":\"$2a$12$uiPXR.maWj5J7Uo9mhjuMe6r.c8b1/sZtEzWV7ptkMnIomFy3l.s2\", \"publish_acl\":[{\"pattern\":\"a/+/c\"}], \"subscribe_acl\":[{\"pattern\":\"a/+/c\"}]}"
{% endhighlight %}

Important:
- **ACL** data for a specific client is read from Redis once - during authentication (MQTT `CONNECT` command), and stay cached until the client disconnects.

## Useful commands

- trace mqtt client:
{% highlight shell %}
vmq-admin trace client client-id=test-client
{% endhighlight %}

## Useful tools
- [Online Bcrypt hash generator](https://8gwifi.org/bccrypt.jsp)
- [Online MQTT Client: (MQTT over ws)](http://www.hivemq.com/demos/websocket-client/)

![Connect Over Web Sockets](/images/mqtt_over_ws_connect_config.png)

