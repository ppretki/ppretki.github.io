---
layout: post
title: VerneMQ on Docker + Redis Auth 
---


### Start services via `docker-compose.yml`:

<script src="https://gist.github.com/ppretki/f09499b78610c2b2b83622f560fde374.js?file=docker_compose_vernemq_auth_redis.yml"></script>

### Configure VerneMQ auth data

- mountpoint=`""`
- client_id=`"test_client"`
- username=`"test_user"`
- password=`"123"`
- Access Control List: `publish_acl=[{pattern:'a/+/c'}], subscribe_acl={pattern:'a/+/c'}`

VerneMQ treats [Redis](https://redis.io/) as a simple key-value storage for both authentication 
and authorization data. Redis entries take following form:

Key: 
{% highlight shell %}
[mountpoint, client_id, unername]
{% endhighlight %}
  
Value:
{% highlight shell %}
{
  "passhash": BCRYPT PASSWORD HASH,
  "publish_acl": [
    {
      "pattern": TOPIC PATTERN
    }
  ],
  "subscribe_acl": [
    {
      "pattern": TOPIC PATTERN
    }
  ]
}
{% endhighlight %} 

[Bcrypt](https://en.wikipedia.org/wiki/Bcrypt) password hash can be easily computed using e.g. [Online Bcrypt hash generator](https://8gwifi.org/bccrypt.jsp) 
~~~
Brypt(pass='123',round=12) = $2a$12$uiPXR.maWj5J7Uo9mhjuMe6r.c8b1/sZtEzWV7ptkMnIomFy3l.s2
~~~   

Insert auth data into Redis:

<script src="https://gist.github.com/ppretki/f09499b78610c2b2b83622f560fde374.js?file=set_auth_data_in_redis.sh"></script>

### Test using [Online MQTT Client: (MQTT over ws)](http://www.hivemq.com/demos/websocket-client/)

![Connect Over Web Sockets](/images/mqtt_over_ws_connect_config.png)


### Important:
- **ACL** data for a specific client are read from Redis once - during authentication (MQTT `CONNECT` command), and stay cached until the client disconnects.

### Useful commands

- trace mqtt client:
{% highlight shell %}
vmq-admin trace client client-id=test-client
{% endhighlight %}

### Useful tools
- [Online Bcrypt hash generator](https://8gwifi.org/bccrypt.jsp)
- [Online MQTT Client: (MQTT over ws)](http://www.hivemq.com/demos/websocket-client/)

